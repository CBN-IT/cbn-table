<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/cbn-icons/cbn-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">


<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/cbn-btn-styles/cbn-btn-styles.html">

<link rel="import" href="../../bower_components/polymer/lib/utils/templatize.html">


<dom-module id="cbn-data-table">
  <template>
    <style include="iron-flex iron-flex-alignment cbn-btn-styles">
      :host {
        display: block;
        @apply (--layout-vertical);
      }

      .cell, .thead-cell, .cell-nr-crt {
        border-bottom: 1px solid rgb(219, 219, 219);
        /*padding: 6px 10px 6px 10px;*/
        padding: 0 5px;
        box-sizing: border-box;

      }

      .cell, .cell-nr-crt {
        vertical-align: middle;
      }

      .thead-cell {
        background: white;
        font-weight: 500;
        color: rgba(0, 0, 0, .54);
        font-size: 15px;
        padding: 0 5px 5px 5px;
        /*height: 56px;*/
      }

      .row:hover .cell, .row:hover .cell-nr-crt {
        background: #eeeeee;
      }

      .row.iron-selected .cell, .row.iron-selected .cell-nr-crt {
        background: #eeeeee;
      }

      input {
        border-radius: 3px;
        border: 1px solid #DDD;
        width: 100%;
        min-width: 60px;
      }

      .head-title {
        padding-top: 10px;
      }

      .head-title:hover {
        color: black;
        cursor: pointer;
      }

      .head-input {
        padding-top: 0;
      }

      .row {
        display: table-row;
        height: 40px;
      }

      .cell, .cell-nr-crt, .thead-cell {
        display: table-cell;
      }

      .thead-cell-nr {
        padding: 0;
        width: 40px;
        text-align: center;
        font-size: 11px;
      }

      .cell-nr-crt {
        text-align: center;
        font-weight: bold;
      }

      .cell-nr-crt > div {
        display: block;
      }

      .cell-nr-crt:hover > div, .row.iron-selected > .cell-nr-crt > div {
        display: none;
      }

      .cell-nr-crt > paper-checkbox {
        display: none;
      }

      .cell-nr-crt:hover > paper-checkbox, .row.iron-selected > .cell-nr-crt > paper-checkbox {
        display: block;
      }

      paper-checkbox {
        --paper-checkbox-label-spacing: 0;
      }

      .cell > div {
        width: 100%;
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .cell {
        height: 40px;
      }
    </style>
    <slot id="slot" name="cbn-columns"></slot>
    <div id="table" style="overflow-x: auto;height:100%;width:100%">
      <div style="display:table;background: white;width:100%;" id="container">
        <div id="bottom"></div>
        <div style="display: table-header-group">
          <div style="display: table-row" id="header">
            <div class="thead-cell thead-cell-nr">
              <div>{{selectedItemsNumber}}</div>
              <div>
                <paper-checkbox checked="{{allSelected}}"></paper-checkbox>
              </div>
              <div>{{filteredItemsNumber}}</div>
            </div>
            <template is="dom-repeat" items="{{columns}}">
              <div style="display: table-cell" class="thead-cell" style$="width:{{item.width}}px">
                <div class="head-title horizontal layout" on-click="setSort">
                  <div class="flex">{{item.title}}</div>
                  <div>
                    <iron-icon icon="{{item.icon}}"></iron-icon>
                  </div>
                </div>
                <div class="head-input">
                  <template is="dom-if" if="{{item.filterable}}" restamp>
                    <input on-input="setFilter"/>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </div>
        <iron-selector attr-for-selected="item-index" style="display: table-row-group;" class="flex"
                       id="selector" multi></iron-selector>
      </div>
    </div>

  </template>
  <script>
        class CbnDataTable extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element){
          static get is() {
              return 'cbn-data-table';
          }

          static get properties() {
              return {
                  columns: {
                      type: Array,
                      observer: "columnsChanged"
                  },
                  items: {
                      type: Array,
                      observer: "itemsChanged"
                  },
                  _filteredItems: {
                      type: Array,
                      notify: true
                  },
                  _selectedItems: {
                      type: Array
                  },
                  _observer: {
                      type: Object
                  },
                  filteredItemsNumber: {
                      type: Number,
                      value: 0
                  },
                  itemsNumber: {
                      type: Number,
                      value: 0
                  },
                  selectedItemsNumber: {
                      type: Number,
                      value: 0
                  },
                  displayedItems: {
                      type: Array
                  },
                  initialized: {
                      type: Boolean,
                      value: false
                  },
                  rowsNr: {
                      type: Number
                  },
                  rowHeight: {
                      type: Number,
                      value: 40
                  },
                  allSelected: {
                      type: Boolean,
                      observer: "selectAll"
                    },
                    viewHeight: {
                        type: Number,
                        value: 0
                  }
              };
          }

          connectedCallback() {
                this.addEventListener('iron-resize', this.debounceResize);
              super.connectedCallback();
          }

          ready() {
              super.ready();
              this.$.table.addEventListener("scroll", this.handleScroll.bind(this));
          }

            debounceResize() {
                this._debouncerResize = Polymer.Debouncer.debounce(this._debouncerResize, Polymer.Async.timeOut.after(100), this.onResize.bind(this))
            }

            onResize(){
                this.itemsChanged();
            }

          columnsChanged(columns) {
              for (let i = 0; i < columns.length; i++) {
                  this.setIcon(columns[i], i);
                  if (columns[i].template) {
                      let template = this.querySelector('template[name="' + columns[i]["name"] + '"]');
                      columns[i].templateConstructor = Polymer.Templatize.templatize(template, this, {
                          mutableData: false,
                          instanceProps: {
                              "item": true,
                              "value": true,
                              "column": true
                          },
                          parentModel: false
                      });
                  }
              }
              // this.changedItems();
          }

          createCellInstance(column, model) {
              return new column.templateConstructor({item: model, column: this, value: this["name"]});
          }

          formatValue(column, item) {
              return item[column.name];
          }

          setIcon(column, columnIndex) {
              this.columns[columnIndex]["sortType"] = this.columns[columnIndex]["sortType"] === undefined ? 0 : this.columns[columnIndex]["sortType"];
              let icon;
              switch (this.columns[columnIndex]["sortType"]) {
                  case 1: {
                      icon = "expand-more";
                      break;
                  }
                  case -1: {
                      icon = "expand-less";
                      break;
                  }
                  default: {
                      icon = "unfold-more";
                  }
              }
              this.set("columns." + columnIndex + ".icon", icon);
          }

          itemsChanged() {
                let viewHeight = this.$.table.getBoundingClientRect()["height"];
                if (this.viewHieght !== viewHeight && viewHeight > 0 && this.columns !== undefined && this.items !== undefined) {
                    this.viewHieght = viewHeight;
                  setTimeout(function () {
                        this.firstRender(viewHeight);
                  }.bind(this));
              }
          }

            firstRender(viewHeight) {
              this.clean();
              this.$.container.style.height = (this.rowHeight * this._filteredItems.length + 60) + "px";
              let currentHeight = 0;
              let endIndex = 0;
              while (endIndex < this._filteredItems.length && currentHeight < viewHeight * 2) {
                  this.createRow(currentHeight, endIndex);
                  currentHeight = currentHeight + this.rowHeight;
                  endIndex++;
              }
              this.startIndex = 0;
              this.endIndex = endIndex - 1;
              this.rowsNr = endIndex;
              this.scrollToTop();
          }

          clean() {
              this.itemsNumber = this.items.length;
              for(let i=0; i< this.items.length; i++){
                  this.items[i]["initialIndex"] = i;
              }
              this._filteredItems = JSON.parse(JSON.stringify(this.items));
              // this._filteredItems = this.items;
              this._selectedItems = [];
              this.filteredItemsNumber = this._filteredItems.length;
              this.selectedItemsNumber = 0;
              let rows = this.$.container.querySelectorAll(".row");
              for (let i = 0; i < rows.length; i++) {
                  this.$.container.removeChild(rows[i]);
              }
          }

          createRow(currentHeight, endIndex) {
              let row = document.createElement("div");
              row.addEventListener("click", this.handleClick.bind(this));
              this.$.container.insertBefore(row, this.$.bottom);
              row.classList.add("row");
              row.setAttribute("translateX", currentHeight);
              row.setAttribute("initialIndex", endIndex);
              row.initialIndex = endIndex;
              row.initial = currentHeight;
              row.translateX = currentHeight;
              row.setAttribute("initial", currentHeight);
              row.lastIndex = endIndex;
              row.style.transform = "translate3d(0px," + 0 + "px,0px)";

              this.createRowCells(row, endIndex);
          }

          createRowCells(row, endIndex) {
              this.createIndexCell(row, endIndex);
              let model = this._filteredItems[endIndex];
              for (let j = 0; j < this.columns.length; j++) {
                  this.createCell(row, model, this.columns[j]);
              }
          }

          createIndexCell(row, endIndex) {
              let cell = document.createElement("div");
              cell.classList.add("cell-nr-crt");
              let nrCrt = document.createElement("div");
              nrCrt.textContent = endIndex + 1;
              let checkbox = document.createElement("paper-checkbox");
              row.checkbox = checkbox;
              cell.appendChild(nrCrt);
              cell.appendChild(checkbox);
              row.appendChild(cell);
          }

          createCell(row, model, column) {
              let cell = document.createElement("div");
              cell.classList.add("cell");
              let container = document.createElement("div");
              if (column["template"]) {
                  let instance = this.createCellInstance(column, model);
                  cell.instance = instance;
                  container.appendChild(instance.root);
              } else {
                  container.textContent = this.formatValue(column, model);
              }
              cell.appendChild(container);
              row.appendChild(cell);
          }

          scrollToTop() {
              setTimeout(function () {
                  this.$.table.scrollTop = 0;
              }.bind(this), 1);
          }

          handleScroll() {
              let scrollTop = this.$.table.scrollTop;
              this.$.header.style.transform = "translate3d(0px, " + scrollTop + "px, 0px)";

              let rowHeight = 40;
              let rows = this.$.container.querySelectorAll(".row");
              rows = Array.prototype.slice.call(rows, 0);
              let rowsParams = this.getRowsParams(rows);
              let rowsToTranslateNumber = rowsParams.rowsTopNr - rowsParams.rowsBottomNr;
              if (rowsParams.rowsTopNr === this.rowsNr || rowsParams.rowsBottomNr === this.rowsNr) {
                  rows = this.repositionRows();
                  rowsParams = this.getRowsParams(rows);
              }

              if (rowsToTranslateNumber > 0) {
                  while (rowsParams.rowsTopNr > rowsParams.rowsBottomNr + 1) {
                      if (this.endIndex < this._filteredItems.length - 1) {
                          rowsParams.firstRow.translateX = (rowsParams.lastTranslateX + rowHeight);
                          rowsParams.firstRow.setAttribute("translateX", rowsParams.firstRow.translateX);
                          rowsParams.firstRow.style.transform = "translate3d(0px," + (rowsParams.lastTranslateX + rowHeight - rowsParams.firstRow.initial) + "px,0px)";
                          this.startIndex++;
                          this.endIndex++;
                          rowsParams = this.getRowsParams(rows);
                      } else {
                          break;
                      }
                  }
              } else {
                  while (rowsParams.rowsBottomNr > rowsParams.rowsTopNr + 1) {
                      if (this.startIndex > 0) {
                          rowsParams.lastRow.translateX = (rowsParams.firstTranslateX - rowHeight);
                          rowsParams.lastRow.setAttribute("translateX", rowsParams.lastRow.translateX);
                          rowsParams.lastRow.style.transform = "translate3d(0px," + (rowsParams.firstTranslateX - rowHeight - rowsParams.lastRow.initial) + "px,0px)";
                          this.startIndex--;
                          this.endIndex--;
                          rowsParams = this.getRowsParams(rows);
                      } else {
                          break;
                      }
                  }
              }
              rows.sort(function (a, b) {
                  return a["translateX"] > b["translateX"] ? 1 : -1;
              });

              for (let i = 0; i < rows.length; i++) {
                  let lastIndex = rows[i]["lastIndex"];
                  if (lastIndex !== this.startIndex + i) {
                      let model = this._filteredItems[this.startIndex + i];
                      this.updateRow(rows[i], model, i);
                      rows[i]["lastIndex"] = this.startIndex + i;
                  }
              }
          }

          updateRow(row, model, index) {
              if (model["isSelected"]) {
                  row.classList.add("iron-selected");
                  row.checkbox.checked = true;
              } else {
                  row.classList.remove("iron-selected");
                  row.checkbox.checked = false;
              }
              this.updateIndexCell(row, index);
              let cells = row.querySelectorAll(".cell");
              for (let j = 0; j < cells.length; j++) {
                  this.updateCell(cells[j], this.columns[j], model);
              }
          }

          updateIndexCell(row, index) {
              let cellNrCrt = row.querySelector(".cell-nr-crt>div");
              cellNrCrt.textContent = this.startIndex + index + 1;
          }

          updateCell(cell, column, model) {
              if (column["template"]) {
                  cell.instance.item = model;
              } else {
                  cell.textContent = this.formatValue(column, model);
              }
          }

          repositionRows() {
              let rowHeight = 40;
              let slidesNr = parseInt(this.$.table.scrollTop / (this.rowsNr * rowHeight));
              let rows = this.$.container.querySelectorAll(".row");
              rows = Array.prototype.slice.call(rows, 0);
              rows.sort(function (a, b) {
                  return a["initialIndex"] > b["initialIndex"] ? 1 : -1;
              });
              if (!(slidesNr > 0 && slidesNr > parseInt(this._filteredItems.length / this.rowsNr) - 1)) {
                  this.startIndex = slidesNr * this.rowsNr;
                  for (let i = 0; i < rows.length; i++) {
                      if (slidesNr * this.rowsNr + i >= 0 && slidesNr * this.rowsNr + i < this._filteredItems.length) {
                          rows[i].translateX = (slidesNr) * (this.rowsNr * rowHeight) + rows[i]["initial"];
                          rows[i].setAttribute("translateX", rows[i].translateX);
                          rows[i].lastIndex = slidesNr * this.rowsNr + i;
                          rows[i].style.transform = "translate3d(0px," + ((slidesNr) * (this.rowsNr * rowHeight)) + "px,0px)";
                          let model = this._filteredItems[slidesNr * this.rowsNr + i];
                          this.updateRow(rows[i], model, i);
                          this.endIndex = slidesNr * this.rowsNr + i;
                      }
                  }
              }

              return rows;

          }

          getRowsParams(rows) {
              rows.sort(function (a, b) {
                  return a["translateX"] > b["translateX"] ? 1 : -1;
              });
              let scrollTop = this.$.table.scrollTop;
              let viewHeight = this.$.table.getBoundingClientRect()["height"];
              let rowsTopNr = 0, rowsBottomNr = 0;
              let lastTranslateX, firstTranslateX;
              firstTranslateX = rows[0].translateX;
              for (let i = 0; i < rows.length; i++) {
                  let toCompare = rows[i]["translateX"];
                  if (toCompare < scrollTop) {
                      rowsTopNr++;
                  } else if (toCompare > scrollTop + viewHeight) {
                      rowsBottomNr++;
                  }
                  lastTranslateX = rows[i]["translateX"];
              }
              return {
                  firstRow: rows[0],
                  lastRow: rows[rows.length - 1],
                  firstTranslateX: firstTranslateX,
                  lastTranslateX: lastTranslateX,
                  rowsTopNr: rowsTopNr,
                  rowsBottomNr: rowsBottomNr
              }
          }

          handleClick(event) {
              let row = event.currentTarget;
              if (this._filteredItems[row.lastIndex]["isSelected"]) {
                  this._filteredItems[row.lastIndex]["isSelected"] = false;
                  row.classList.remove("iron-selected");
                  row.checkbox.checked = false;
                  this.selectedItemsNumber--;
              } else {
                  this._filteredItems[row.lastIndex]["isSelected"] = true;
                  row.classList.add("iron-selected");
                  row.checkbox.checked = true;
                  this.selectedItemsNumber++;
              }
          }

          setSort(event) {
              if (this.columns[event.model.index]["sortable"]) {
                  for (let i = 0; i < this.columns.length; i++) {
                      if (i !== event.model.index) {
                          this.columns[i]["sortType"] = 0;
                      } else if (this.columns[i]["sortType"] === 0) {
                          this.columns[i]["sortType"] = 1;
                      } else if (this.columns[i]["sortType"] === 1) {
                          this.columns[i]["sortType"] = -1;
                      } else {
                          this.columns[i]["sortType"] = 0;
                      }
                  }
                  this.setIcon(this.columns[event.model.index], event.model.index);
                  this.sortAll(this.columns[event.model.index]["name"], this.columns[event.model.index]["sortType"]);
              }
          }

          sortAll(property, sortType) {
              this._filteredItems.sort(function (a, b) {
                  return a[property].localeCompare(b[property]) * sortType
              });
              this.updateFilteredItems();
          }

          setFilter(event) {
              let target = event.currentTarget;
              this.columns[event.model.index]["filterValue"] = target.value;
              this.filterAll();
          }

          filterAll() {
              if (this.columns !== undefined) {
                  let _filteredItems = [];
                  for (let i = 0; i < this.items.length; i++) {
                      let displayRow = true;
                      for (let j = 0; j < this.columns.length; j++) {
                          if (this.columns[j]["filterable"]) {
                              if (this.columns[j]["filterValue"] !== undefined && this.columns[j]["filterValue"] !== "") {
                                  if (this.items[i][this.columns[j]["name"]].toLowerCase().indexOf(this.columns[j]["filterValue"].toLowerCase()) === -1) {
                                      displayRow = false;
                                      break;
                                  }
                              }
                          }
                      }
                      if (displayRow) {
                          _filteredItems.push(this.items[i]);
                      }
                  }
                  this._filteredItems = _filteredItems;
                  this.updateFilteredItems();

              }

          }

          updateFilteredItems() {
              this.filteredItemsNumber = this._filteredItems.length;
              let rowHeight = 40;
              let rows = this.$.container.querySelectorAll(".row");
              rows = Array.prototype.slice.call(rows, 0);
              rows.sort(function (a, b) {
                  return a["initialIndex"] > b["initialIndex"] ? 1 : -1;
              });
              for (let i = 0; i < rows.length; i++) {
                  if (i < this._filteredItems.length) {
                      rows[i].style.display = "table-row";
                  } else {
                      rows[i].style.display = "none";
                  }
              }
              this.$.container.style.height = (rowHeight * this._filteredItems.length + 60) + "px";
              setTimeout(function () {
                  if (this.$.table.scrollTop !== 0) {
                      this.$.table.scrollTop = 0;
                  } else {
                      this.repositionRows();
                  }
              }.bind(this), 1);

          }

          selectedRow(event) {
              if (!event.detail.item.querySelector("paper-checkbox")["checked"]) {
                  event.detail.item.querySelector("paper-checkbox")["checked"] = true;
              }
              this.selectedItemsNumber = this.$.selector.selectedItems.length;
          }

          deselectedRow(event) {
              if (event.detail.item.querySelector("paper-checkbox")["checked"]) {
                  event.detail.item.querySelector("paper-checkbox")["checked"] = false;
              }
              this.selectedItemsNumber = this.$.selector.selectedItems.length;
          }

          selectAll() {
              if(this._filteredItems !== undefined){
                  for (let i = 0; i < this._filteredItems.length; i++) {
                      if (this._filteredItems[i]["isSelected"] !== this.allSelected) {
                          this._filteredItems[i]["isSelected"] = this.allSelected;
                      }
                  }
                  this.selectedItemsNumber = this._filteredItems.length;
                  let rows = this.$.container.querySelectorAll(".row");
                  for (let i = 0; i < rows.length; i++) {
                      rows[i].checkbox.checked = this.allSelected;
                      if(this.allSelected){
                          rows[i].classList.add("iron-selected");
                      } else {
                          rows[i].classList.remove("iron-selected");
                      }
                  }
              }
          }

          get selectedItems(){
              let selectedItems = [];
              for (let i = 0; i < this._filteredItems.length; i++) {
                  if (this._filteredItems[i]["isSelected"]) {
                      selectedItems.push(this._filteredItems[i]);
                  }
              }
              return selectedItems;
          }
      }

      window.customElements.define(CbnDataTable.is, CbnDataTable);
  </script>
</dom-module>
